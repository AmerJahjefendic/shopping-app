<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pametna Shopping Lista</title>

    <!-- Manifest (PRAVILNA putanja!) -->
    <link rel="manifest" href="manifest.json">

    <!-- Service Worker registracija -->
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body { font-family: 'Arial', sans-serif; margin:0; padding:0; background:#f4f7f9; }
.header { background:#4A90E2; color:white; padding:18px 10px; text-align:center; font-size:22px; font-weight:bold; }
.top-box { padding:15px; background:#fff; display:flex; gap:10px; flex-wrap:wrap;
           position:sticky; top:0; z-index:10; box-shadow:0 3px 8px rgba(0,0,0,0.05); }
#searchInput,#sortBtn{ padding:10px; border-radius:6px; font-size:15px; }
#searchInput{ flex:1; border:1px solid #ddd; }
#sortBtn{ background:#4A90E2; color:white; border:none; cursor:pointer; }

.tabs{ display:flex; margin:15px; gap:10px; }
.tab{ flex:1; padding:10px; border-radius:6px; background:#ddd;
      font-size:20px; cursor:pointer; font-weight:bold; border:none; }
.tab.active{ background:#4A90E2; color:white; }

.add-box{ padding:15px; background:#fff; display:flex; gap:10px; margin:0 15px;
          border-radius:8px; flex-wrap:wrap; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
#item-name,#item-home{ padding:10px; border:1px solid #ddd; border-radius:6px; font-size:15px; }
#item-name{ flex:1; }
#addItem{ background:#50C878; color:white; border:none; padding:10px 15px;
          border-radius:6px; cursor:pointer; }

.quick-add{ display:flex; gap:10px; margin:10px 15px; flex-wrap:wrap; }
.quick-btn{ background:#f0f0f0; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; }
.quick-btn:hover{ background:#e4e4e4; }

.sync-buttons,.share-buttons{ display:flex; gap:10px; margin:0 15px 15px 15px; }
.sync-buttons button,.share-buttons button{
    flex:1; padding:10px; border:none; border-radius:6px; color:white; cursor:pointer;
}
#saveDrive{ background:#50C878; }
#loadDrive{ background:#666; }
#shareBuy{ background:#4A90E2; }
#shareAll{ background:#333; }

.list{ display:none; list-style:none; margin:0 15px; padding:0; }
.list.active{ display:block; }

li{ background:#fff; margin-bottom:8px; padding:12px; border-radius:8px;
    display:flex; justify-content:space-between; align-items:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.05); }
li.alt{ background:#f2f2f2; }
.item-name{ font-size:16px; font-weight:bold; }

.qty-box{ display:flex; gap:8px; align-items:center; }
.qty-btn{
    width:32px; height:32px; background:#4A90E2; color:white;
    border:none; border-radius:6px; font-size:18px; cursor:pointer;
}
.delete-btn{ color:#FF6347; font-size:20px; cursor:pointer; }
</style>
</head>
<body>

<div class="header">üõí Pametna Shopping Lista</div>

<div class="top-box">
    <input id="searchInput" type="text" placeholder="Pretraga...">
    <button id="sortBtn"><i class="fa-solid fa-arrow-down-a-z"></i></button>
</div>

<div class="add-box">
    <input id="item-name" type="text" placeholder="Naziv artikla...">
    <select id="item-home">
        <option value="imamo">Imamo</option>
        <option value="frizider">Fri≈æider</option>
        <option value="zamrzivac">Zamrzivaƒç</option>
    </select>
    <button id="addItem">‚ûï Dodaj</button>
</div>

<div class="quick-add">
    <button class="quick-btn">Mlijeko ü•õ</button>
    <button class="quick-btn">Hljeb üçû</button>
    <button class="quick-btn">Jaja ü•ö</button>
    <button class="quick-btn">ABC sir</button>
</div>

<div class="sync-buttons">
    <button id="saveDrive">Snimi</button>
    <button id="loadDrive">Uƒçitaj</button>
</div>

<div class="share-buttons">
    <button id="shareBuy">üì§ Podijeli Kupiti</button>
    <button id="shareAll">üì§ Podijeli Sve</button>
</div>

<div class="tabs">
    <button class="tab active" data-tab="kupiti">üõçÔ∏è Kupiti</button>
    <button class="tab" data-tab="imamo">üì¶ Imamo</button>
    <button class="tab" data-tab="frizider">üßä Fri≈æider</button>
    <button class="tab" data-tab="zamrzivac">‚ùÑÔ∏è Zamrzivaƒç</button>
</div>

<ul id="list-kupiti" class="list active"></ul>
<ul id="list-imamo" class="list"></ul>
<ul id="list-frizider" class="list"></ul>
<ul id="list-zamrzivac" class="list"></ul>

<script>
let items = [];
let activeTab = "kupiti";

function isIOS(){
    return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

function loadLocal(){
    const s = localStorage.getItem("shoppingItems");
    if (s) items = JSON.parse(s);
}

function saveLocal(){
    localStorage.setItem("shoppingItems", JSON.stringify(items));
}

function renderLists(){
    const search = document.getElementById("searchInput").value.toLowerCase();
    const cats = ["kupiti","imamo","frizider","zamrzivac"];

    cats.forEach(c => document.getElementById("list-" + c).innerHTML = "");

    const grouped = { kupiti:[], imamo:[], frizider:[], zamrzivac:[] };
    items.forEach((it,i)=> grouped[it.currentCategory].push({item:it, i}));

    cats.forEach(cat => {
        const ul = document.getElementById("list-" + cat);

        grouped[cat]
            .filter(x => x.item.name.toLowerCase().includes(search))
            .forEach((x,idx)=>{
                let qty = x.item.qty || 1;

                const li = document.createElement("li");
                if (idx % 2 === 1) li.classList.add("alt");
                li.onclick = () => toggleItem(x.i);

                li.innerHTML = `
                    <div class="item-name">${x.item.name} (${qty})</div>
                    <div class="qty-box">
                        <button class="qty-btn minus"><i class="fa-solid fa-minus"></i></button>
                        <button class="qty-btn plus"><i class="fa-solid fa-plus"></i></button>
                        <i class="fa-solid fa-trash delete-btn"></i>
                    </div>`;

                li.querySelector(".minus").onclick = e => {
                    e.stopPropagation();
                    x.item.qty = Math.max(1, x.item.qty - 1);
                    saveLocal(); renderLists();
                };

                li.querySelector(".plus").onclick = e => {
                    e.stopPropagation();
                    x.item.qty++;
                    saveLocal(); renderLists();
                };

                li.querySelector(".delete-btn").onclick = e => {
                    e.stopPropagation();
                    items.splice(x.i,1);
                    saveLocal(); renderLists();
                };

                ul.appendChild(li);
            });
    });
}

function toggleItem(i){
    const item = items[i];
    item.currentCategory =
        item.currentCategory === "kupiti"
        ? item.homeCategory
        : "kupiti";

    saveLocal();
    renderLists();
}

document.getElementById("addItem").onclick = () => {
    const name = document.getElementById("item-name").value.trim();
    const home = document.getElementById("item-home").value;
    if (!name) return;

    if (items.some(x => x.name.toLowerCase() === name.toLowerCase()))
        return alert("Artikal veƒá postoji!");

    items.push({ name, homeCategory:home, currentCategory:"kupiti", qty:1 });
    saveLocal(); renderLists();
    document.getElementById("item-name").value="";
};

document.getElementById("sortBtn").onclick = () => {
    items.sort((a,b)=>a.name.localeCompare(b.name,"bs"));
    saveLocal(); renderLists();
};
document.getElementById("searchInput").oninput = renderLists;

document.querySelectorAll(".tab").forEach(btn=>{
    btn.onclick = () => {
        activeTab = btn.dataset.tab;
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".list").forEach(l=>l.classList.remove("active"));
        document.getElementById("list-"+activeTab).classList.add("active");
    };
});

document.getElementById("saveDrive").onclick = async () => {
    const json = JSON.stringify(items,null,2);
    const blob = new Blob([json],{type:"application/json"});

    if (isIOS()){
        try {
            await navigator.share({
                title:"shopping_backup.json",
                text:"Backup",
                files:[new File([blob], "shopping_backup.json")]
            });
        } catch {}
        return;
    }

    try{
        const h = await window.showSaveFilePicker({
            suggestedName:"shopping_backup.json",
            types:[{ description:"JSON", accept:{"application/json":[".json"]}}]
        });

        const w = await h.createWritable();
        await w.truncate(0);
        await w.write(json);
        await w.close();
        alert("Saƒçuvano!");
    }catch{}
};

document.getElementById("loadDrive").onclick = async () => {
    try{
        const [h] = await window.showOpenFilePicker({
            types:[{description:"JSON",accept:{"application/json":[".json"]}}]
        });

        const f = await h.getFile();
        let lo = JSON.parse(await f.text());
        lo = lo.map(x => ({...x, qty:x.qty||1}));

        items = lo;
        saveLocal();
        renderLists();
        alert("Uƒçitano!");
    }catch{}
};

const quickHome={
    "Mlijeko":"imamo",
    "Hljeb":"imamo",
    "Jaja":"frizider",
    "Piletina":"zamrzivac",
    "Pasta":"imamo",
    "Banane":"imamo",
    "ABC sir":"frizider"
};

document.querySelectorAll(".quick-btn").forEach(btn=>{
    btn.onclick = () => {
        let raw = btn.innerText.trim();
        let name = raw.replace(/[^\p{L}\p{N}\s]/gu, "").trim();

        if (items.some(x=>x.name.toLowerCase()===name.toLowerCase()))
            return alert("Artikal veƒá postoji!");

        let homeCat = quickHome[name] || "imamo";

        items.push({ name, homeCategory:homeCat, currentCategory:"kupiti", qty:1 });

        saveLocal();
        renderLists();
    };
});

document.getElementById("shareBuy").onclick = async()=>{
    const list = items.filter(x=>x.currentCategory==="kupiti");
    if (!list.length) return alert("Lista Kupiti je prazna.");

    const text =
        "KUPITI:\n" +
        list.map(x => `- ${x.name} (${x.qty})`).join("\n");

    if (navigator.share){
        try { await navigator.share({title:"Kupiti", text}); } catch {}
    } else {
        navigator.clipboard.writeText(text);
        alert("Kopirano!");
    }
};

document.getElementById("shareAll").onclick = async()=>{
    const cats=["kupiti","imamo","frizider","zamrzivac"];
    const labels={kupiti:"KUPITI", imamo:"IMAMO", frizider:"FRI≈ΩIDER", zamrzivac:"ZAMRZIVAƒå"};

    let text="";

    cats.forEach(cat=>{
        const arr=items.filter(x=>x.currentCategory===cat);
        text += labels[cat] + ":\n";
        text += arr.length
            ? arr.map(x=>`- ${x.name} (${x.qty})`).join("\n") + "\n\n"
            : "- (prazno)\n\n";
    });

    if (navigator.share){
        try { await navigator.share({title:"Shopping lista", text}); } catch {}
    } else {
        navigator.clipboard.writeText(text);
        alert("Sve kopirano!");
    }
};

loadLocal();
renderLists();
</script>
</body>
</html>
